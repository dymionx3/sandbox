<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M.V. Electronix LLC - PDF Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * { 
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    }
    
    .gradient-bg { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text;
    }
    
    .hover-scale { 
      transition: transform .25s cubic-bezier(.4,0,.2,1); 
    }
    
    .hover-scale:hover { 
      transform: translateY(-2px) scale(1.02); 
    }
    
    .floating { 
      animation: floating 6s ease-in-out infinite; 
    }
    
    @keyframes floating { 
      0% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
      100% { transform: translateY(0) rotate(360deg); }
    }
    
    .text-editor { 
      min-height: 200px; 
      border: 2px solid #e5e7eb; 
      border-radius: .75rem; 
      padding: 1.25rem; 
      outline: none;
    }
    
    .text-editor:focus { 
      border-color: #667eea; 
      box-shadow: 0 0 0 4px rgba(102,126,234,.1);
    }
    
    .file-drop-zone { 
      transition: all .3s ease; 
      border: 3px dashed #cbd5e1;
      background: rgba(249, 250, 251, 0.5);
    }
    
    .file-drop-zone.dragover { 
      border-color: #667eea; 
      background-color: rgba(102,126,234,.05); 
    }
    
    .slide-in { 
      animation: slideIn .4s ease-out; 
    }
    
    @keyframes slideIn { 
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .signature-canvas {
      touch-action: none;
      cursor: crosshair;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
  <!-- Animated Background -->
  <div aria-hidden="true" class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 floating"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-indigo-300 rounded-full mix-blend-multiply filter blur-xl opacity-30 floating" style="animation-delay: 2s"></div>
  </div>

  <!-- Header -->
  <header class="relative z-10 bg-white/80 backdrop-blur-sm shadow-lg" role="banner">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-center">
        <div class="flex items-center gap-3" aria-label="App brand">
          <div class="w-12 h-12 gradient-bg rounded-xl grid place-items-center shadow-md" aria-hidden="true">
            <i class="fas fa-file-pdf text-white text-2xl"></i>
          </div>
          <div class="text-center">
            <h1 class="text-2xl font-bold gradient-text">PDF Studio</h1>
            <p class="text-sm text-gray-600">by M.V. Electronix LLC</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative z-10 py-16 md:py-20 flex-grow">
    <div class="max-w-5xl mx-auto px-4 text-center">
      <h2 class="text-5xl md:text-6xl font-extrabold mb-6"><span class="gradient-text">Transform Your PDFs</span></h2>
      <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-2xl mx-auto">Powerful PDF tools by M.V. Electronix LLC. Create, edit, fill, merge, split, and more — all client‑side, private by default.</p>
      <button onclick="scrollToTools()" 
              class="gradient-bg text-white px-8 py-4 rounded-full font-semibold hover-scale shadow-lg 
                     focus:outline-none focus:ring-4 focus:ring-purple-300 flex items-center justify-center gap-2 mx-auto">
        Get Started <i class="fas fa-arrow-down"></i>
      </button>
    </div>
  </section>

  <!-- Tools -->
  <section id="tools" class="relative z-10 py-12 md:py-16">
    <div class="max-w-7xl mx-auto px-4">
      <h3 class="text-3xl font-bold text-center mb-10 gradient-text">PDF Tools by M.V. Electronix LLC</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Tool Cards -->
        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('create')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-plus-circle text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Create PDF</h4>
          <p class="text-gray-600">Create a PDF from text, images, or a blank document.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('fill')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-signature text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Fill & Sign</h4>
          <p class="text-gray-600">Add text boxes and a drawn signature.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('edit')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-pencil-alt text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Edit PDF</h4>
          <p class="text-gray-600">Add annotations and drawings to PDF.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('merge')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-layer-group text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Merge PDFs</h4>
          <p class="text-gray-600">Combine PDFs without losing text quality.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('split')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-cut text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Split PDF</h4>
          <p class="text-gray-600">Extract page ranges to new files.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('compress')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-compress text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Compress PDF</h4>
          <p class="text-gray-600">Reduce PDF file size.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('convert')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-file-arrow-down text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Convert to PDF</h4>
          <p class="text-gray-600">Convert images (JPG/PNG) & text files.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('watermark')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-stamp text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Add Watermark</h4>
          <p class="text-gray-600">Text watermark with color, opacity, angle.</p>
        </button>

        <button class="tool-card bg-white rounded-2xl shadow-lg p-6 hover-scale text-left border border-gray-100"
                onclick="openTool('rotate')">
          <div class="w-16 h-16 gradient-bg rounded-xl grid place-items-center mb-4">
            <i class="fas fa-rotate-right text-white text-2xl"></i>
          </div>
          <h4 class="text-xl font-bold mb-2 text-gray-800">Rotate Pages</h4>
          <p class="text-gray-600">Rotate all or selected pages.</p>
        </button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="relative z-10 bg-gray-900 text-white py-8 mt-auto">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <div class="mb-4">
        <h3 class="text-2xl font-bold gradient-text">M.V. Electronix LLC</h3>
        <p class="text-gray-400 mt-2">Innovative PDF Solutions</p>
      </div>
      <div class="flex justify-center gap-6 mb-4">
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-linkedin text-xl"></i></a>
        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-github text-xl"></i></a>
      </div>
      <p class="text-gray-500 text-sm">© <span id="year"></span> M.V. Electronix LLC. All rights reserved.</p>
    </div>
  </footer>

  <!-- Modal -->
  <div id="toolModal" class="fixed inset-0 bg-black/50 z-50 hidden" role="dialog">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden slide-in">
        <div class="gradient-bg p-6 text-white">
          <div class="flex items-center justify-between">
            <div>
              <h3 id="toolTitle" class="text-2xl font-bold">Tool</h3>
              <p class="text-sm/relaxed opacity-90">Powered by M.V. Electronix LLC</p>
            </div>
            <button onclick="closeTool()" class="text-white hover:text-gray-200 focus:outline-none p-2">
              <i class="fas fa-times text-2xl"></i>
            </button>
          </div>
        </div>
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
          <div id="toolContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
      <div class="loading-spinner"></div>
      <p class="text-gray-700 font-medium">Processing...</p>
    </div>
  </div>

  <script>
    // ========== GLOBAL STATE ==========
    let currentTool = '';
    let uploadedFiles = [];
    let uploadedImages = [];
    let savedSignature = null;
    let signatureDrawing = false;
    
    // ========== DOM UTILS ==========
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    
    // ========== UI FUNCTIONS ==========
    function scrollToTools() {
      document.getElementById('tools').scrollIntoView({ behavior: 'smooth' });
    }
    
    function showLoading() {
      $('#loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
      $('#loadingOverlay').classList.add('hidden');
    }
    
    function notify(message, type = 'info') {
      const container = $('#notificationContainer');
      const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
      };
      
      const n = document.createElement('div');
      n.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 max-w-sm`;
      n.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white/70 hover:text-white">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(n);
      setTimeout(() => {
        n.style.opacity = '0';
        n.style.transform = 'translateX(100%)';
        setTimeout(() => n.remove(), 300);
      }, 4000);
    }
    
    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }
    
    function downloadBytes(bytes, filename) {
      const blob = new Blob([bytes], { type: 'application/pdf' });
      downloadBlob(blob, filename);
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
    }
    
    // ========== MODAL FUNCTIONS ==========
    function openTool(toolName) {
      currentTool = toolName;
      const modal = $('#toolModal');
      const title = $('#toolTitle');
      const content = $('#toolContent');
      
      const toolConfig = {
        create: { title: 'Create PDF', content: getCreateContent() },
        fill: { title: 'Fill & Sign', content: getFillContent() },
        edit: { title: 'Edit PDF', content: getEditContent() },
        merge: { title: 'Merge PDFs', content: getMergeContent() },
        split: { title: 'Split PDF', content: getSplitContent() },
        compress: { title: 'Compress PDF', content: getCompressContent() },
        convert: { title: 'Convert to PDF', content: getConvertContent() },
        watermark: { title: 'Add Watermark', content: getWatermarkContent() },
        rotate: { title: 'Rotate Pages', content: getRotateContent() },
      };
      
      if (!toolConfig[toolName]) return;
      
      title.textContent = toolConfig[toolName].title;
      content.innerHTML = toolConfig[toolName].content;
      modal.classList.remove('hidden');
      
      // Initialize tool-specific functionality
      if (toolName === 'create') initCreateTool();
      else if (toolName === 'fill') initFillTool();
      else if (toolName === 'edit') initEditTool();
      else initDragAndDrop();
    }
    
    function closeTool() {
      $('#toolModal').classList.add('hidden');
      uploadedFiles = [];
      uploadedImages = [];
      savedSignature = null;
    }
    
    // ========== CREATE PDF TOOL ==========
    function getCreateContent() {
      return `
        <div class="space-y-6">
          <div class="bg-gray-50 p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Create PDF from:</h4>
            <div class="space-y-3">
              <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="createType" value="text" checked class="text-purple-600">
                <div><p class="font-medium">Text Document</p><p class="text-sm text-gray-500">Write or paste formatted text</p></div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="createType" value="images" class="text-purple-600">
                <div><p class="font-medium">Images</p><p class="text-sm text-gray-500">Convert JPG/PNG to PDF pages</p></div>
              </label>
              <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-100">
                <input type="radio" name="createType" value="blank" class="text-purple-600">
                <div><p class="font-medium">Blank Document</p><p class="text-sm text-gray-500">Create empty pages</p></div>
              </label>
            </div>
          </div>
          
          <div id="textCreate" class="space-y-4">
            <label class="block text-sm font-medium">Document Title
              <input type="text" id="docTitle" placeholder="Enter document title" 
                     class="mt-1 w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-purple-500" />
            </label>
            <label class="block text-sm font-medium">Content
              <div contenteditable="true" id="textContent" class="text-editor" 
                   placeholder="Start typing your content here..."></div>
            </label>
            <div class="grid grid-cols-2 gap-4">
              <label class="block text-sm font-medium">Font Size
                <select id="fontSizeSelect" class="mt-1 w-full px-4 py-2 border rounded-lg">
                  <option value="12">12px</option><option value="14" selected>14px</option>
                  <option value="16">16px</option><option value="18">18px</option>
                </select>
              </label>
              <label class="block text-sm font-medium">Page Size
                <select id="pageSize" class="mt-1 w-full px-4 py-2 border rounded-lg">
                  <option value="a4">A4</option><option value="letter">Letter</option>
                </select>
              </label>
            </div>
          </div>
          
          <div id="imageCreate" class="hidden space-y-4">
            <div class="file-drop-zone p-8 rounded-lg text-center" id="imageDrop">
              <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
              <p class="text-lg text-gray-600 mb-2">Drag & drop images here</p>
              <input type="file" id="imageInput" multiple accept="image/*" class="hidden" />
              <button onclick="document.getElementById('imageInput').click()" 
                      class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Images</button>
            </div>
            <div id="imageList" class="space-y-2"></div>
          </div>
          
          <div id="blankCreate" class="hidden space-y-4">
            <div class="grid grid-cols-3 gap-4">
              <label class="block text-sm font-medium">Page Size
                <select id="blankPageSize" class="mt-1 w-full px-4 py-2 border rounded-lg">
                  <option value="a4">A4</option><option value="letter">Letter</option>
                </select>
              </label>
              <label class="block text-sm font-medium">Pages
                <input type="number" id="pageCount" min="1" value="1" 
                       class="mt-1 w-full px-4 py-2 border rounded-lg" />
              </label>
              <label class="block text-sm font-medium">Orientation
                <select id="orientation" class="mt-1 w-full px-4 py-2 border rounded-lg">
                  <option value="portrait">Portrait</option><option value="landscape">Landscape</option>
                </select>
              </label>
            </div>
          </div>
          
          <button onclick="handleCreatePDF()" 
                  class="gradient-bg text-white px-6 py-3 rounded-lg hover-scale w-full font-semibold">
            Create PDF
          </button>
        </div>
      `;
    }
    
    function initCreateTool() {
      // Show/hide sections based on radio selection
      $$('input[name="createType"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const type = this.value;
          $('#textCreate').classList.toggle('hidden', type !== 'text');
          $('#imageCreate').classList.toggle('hidden', type !== 'images');
          $('#blankCreate').classList.toggle('hidden', type !== 'blank');
          
          if (type === 'images') {
            initImageUpload();
          }
        });
      });
      
      // Initialize text editor placeholder
      const editor = $('#textContent');
      editor.textContent = 'Start typing your content here...';
      editor.addEventListener('focus', function() {
        if (this.textContent === 'Start typing your content here...') {
          this.textContent = '';
        }
      });
    }
    
    function initImageUpload() {
      const dropZone = $('#imageDrop');
      const input = $('#imageInput');
      
      ['dragover', 'dragenter'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });
      
      ['dragleave', 'dragend', 'drop'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });
      
      dropZone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files);
        handleImageUpload(files);
      });
      
      input.addEventListener('change', (e) => {
        handleImageUpload(Array.from(e.target.files));
      });
    }
    
    function handleImageUpload(files) {
      uploadedImages = [];
      const list = $('#imageList');
      list.innerHTML = '';
      
      files.forEach((file, index) => {
        if (!file.type.startsWith('image/')) {
          notify('Skipped non-image file: ' + file.name, 'error');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImages.push(e.target.result);
          
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
          div.innerHTML = `
            <div class="flex items-center gap-3">
              <img src="${e.target.result}" class="w-12 h-12 object-cover rounded" alt="Preview">
              <div>
                <p class="font-medium">${file.name}</p>
                <p class="text-sm text-gray-500">${formatFileSize(file.size)}</p>
              </div>
            </div>
            <button onclick="removeImage(${index})" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          list.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    }
    
    function removeImage(index) {
      uploadedImages.splice(index, 1);
      const list = $('#imageList');
      list.innerHTML = '';
      
      uploadedImages.forEach((src, idx) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${src}" class="w-12 h-12 object-cover rounded" alt="Preview">
            <div>
              <p class="font-medium">Image ${idx + 1}</p>
            </div>
          </div>
        `;
        list.appendChild(div);
      });
    }
    
    async function handleCreatePDF() {
      const type = document.querySelector('input[name="createType"]:checked').value;
      
      try {
        showLoading();
        
        if (type === 'text') {
          await createTextPDF();
        } else if (type === 'images') {
          await createImagePDF();
        } else if (type === 'blank') {
          await createBlankPDF();
        }
      } catch (error) {
        console.error('Error creating PDF:', error);
        notify('Error creating PDF: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function createTextPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const title = $('#docTitle').value || 'Untitled Document';
      const content = $('#textContent').innerText || 'No content';
      const fontSize = parseInt($('#fontSizeSelect').value);
      const pageSize = $('#pageSize').value;
      
      doc.setFontSize(fontSize);
      doc.text(title, 20, 30);
      
      const lines = doc.splitTextToSize(content, 170);
      doc.text(lines, 20, 50);
      
      doc.save(`${title.replace(/[^a-z0-9]/gi, '_')}.pdf`);
      notify('PDF created successfully!', 'success');
    }
    
    async function createImagePDF() {
      if (uploadedImages.length === 0) {
        notify('Please upload at least one image', 'error');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      for (let i = 0; i < uploadedImages.length; i++) {
        if (i > 0) doc.addPage();
        
        const img = new Image();
        img.src = uploadedImages[i];
        
        await new Promise((resolve) => {
          img.onload = () => {
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // Calculate dimensions to fit the page
            const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
            const width = img.width * ratio;
            const height = img.height * ratio;
            const x = (pageWidth - width) / 2;
            const y = (pageHeight - height) / 2;
            
            doc.addImage(img, 'JPEG', x, y, width, height);
            resolve();
          };
        });
      }
      
      doc.save('images.pdf');
      notify('PDF created from images!', 'success');
    }
    
    async function createBlankPDF() {
      const { jsPDF } = window.jspdf;
      const pageSize = $('#blankPageSize').value;
      const pageCount = parseInt($('#pageCount').value);
      const orientation = $('#orientation').value;
      
      const doc = new jsPDF({
        orientation: orientation,
        unit: 'mm',
        format: pageSize
      });
      
      for (let i = 1; i < pageCount; i++) {
        doc.addPage();
      }
      
      doc.save('blank_document.pdf');
      notify('Blank PDF created!', 'success');
    }
    
    // ========== FILL & SIGN TOOL ==========
    function getFillContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="formFields" class="hidden space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Signature</h4>
              <canvas id="signatureCanvas" class="w-full border rounded-lg signature-canvas" 
                      style="height: 150px; background: white;"></canvas>
              <div class="flex gap-2 mt-3">
                <button onclick="clearSignature()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                  Clear
                </button>
                <button onclick="saveSignature()" class="gradient-bg text-white px-4 py-2 rounded-lg hover-scale">
                  Save Signature
                </button>
              </div>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Add Text</h4>
              <input type="text" id="textToAdd" placeholder="Enter text to add" 
                     class="w-full px-4 py-2 border rounded-lg mb-3">
              <div class="grid grid-cols-2 gap-3">
                <input type="number" id="textX" placeholder="X position" class="px-4 py-2 border rounded-lg" value="50">
                <input type="number" id="textY" placeholder="Y position" class="px-4 py-2 border rounded-lg" value="100">
              </div>
            </div>
          </div>
          
          <button id="fillBtn" onclick="fillPDF()" 
                  class="gradient-bg text-white px-6 py-3 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Fill & Save PDF
          </button>
        </div>
      `;
    }
    
    function initFillTool() {
      initDragAndDrop();
      initSignatureCanvas();
    }
    
    function initSignatureCanvas() {
      const canvas = $('#signatureCanvas');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      ctx.strokeStyle = '#000000';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      let isDrawing = false;
      let lastX = 0;
      let lastY = 0;
      
      const startDrawing = (e) => {
        isDrawing = true;
        [lastX, lastY] = getMousePos(canvas, e);
      };
      
      const draw = (e) => {
        if (!isDrawing) return;
        const [x, y] = getMousePos(canvas, e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        
        [lastX, lastY] = [x, y];
      };
      
      const stopDrawing = () => {
        isDrawing = false;
      };
      
      const getMousePos = (canvas, evt) => {
        const rect = canvas.getBoundingClientRect();
        let x, y;
        
        if (evt.type.includes('touch')) {
          x = evt.touches[0].clientX - rect.left;
          y = evt.touches[0].clientY - rect.top;
        } else {
          x = evt.clientX - rect.left;
          y = evt.clientY - rect.top;
        }
        
        return [x, y];
      };
      
      // Mouse events
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrawing(e);
      }, { passive: false });
      
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        draw(e);
      }, { passive: false });
      
      canvas.addEventListener('touchend', stopDrawing);
    }
    
    function clearSignature() {
      const canvas = $('#signatureCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    function saveSignature() {
      const canvas = $('#signatureCanvas');
      savedSignature = canvas.toDataURL('image/png');
      notify('Signature saved!', 'success');
    }
    
    async function fillPDF() {
      if (uploadedFiles.length === 0) {
        notify('Please upload a PDF file first', 'error');
        return;
      }
      
      try {
        showLoading();
        
        const file = uploadedFiles[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        
        // Add signature if saved
        if (savedSignature) {
          const signatureImage = await pdfDoc.embedPng(savedSignature);
          const pages = pdfDoc.getPages();
          
          pages.forEach((page) => {
            const { width, height } = page.getSize();
            const imgDims = signatureImage.scale(0.3);
            
            page.drawImage(signatureImage, {
              x: width - imgDims.width - 20,
              y: 20,
              width: imgDims.width,
              height: imgDims.height,
            });
          });
        }
        
        // Add text if provided
        const textToAdd = $('#textToAdd')?.value;
        if (textToAdd) {
          const x = parseInt($('#textX')?.value || 50);
          const y = parseInt($('#textY')?.value || 100);
          const pages = pdfDoc.getPages();
          
          pages.forEach((page) => {
            page.drawText(textToAdd, {
              x: x,
              y: y,
              size: 12,
            });
          });
        }
        
        const pdfBytes = await pdfDoc.save();
        downloadBytes(pdfBytes, `filled_${file.name}`);
        notify('PDF filled and saved!', 'success');
      } catch (error) {
        console.error('Error filling PDF:', error);
        notify('Error filling PDF: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    // ========== MERGE PDF TOOL ==========
    function getMergeContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop PDF files</p>
            <p class="text-sm text-gray-500 mb-4">Order matters — use arrows to reorder</p>
            <input type="file" id="fileInput" multiple accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="fileList" class="space-y-2"></div>
          
          <div class="flex gap-3">
            <button onclick="clearFiles()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
              Clear All
            </button>
            <button id="mergeBtn" onclick="mergePDFs()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale flex-1 disabled:opacity-50"
                    disabled>
              Merge PDFs
            </button>
          </div>
        </div>
      `;
    }
    
    // ========== SPLIT PDF TOOL ==========
    function getSplitContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="splitOptions" class="hidden space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Split Options</h4>
              <div class="space-y-3">
                <label class="flex items-center gap-2">
                  <input type="radio" name="splitType" value="ranges" checked class="text-purple-600">
                  <span>Page ranges (e.g., 1-3,5,8-10)</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="splitType" value="single" class="text-purple-600">
                  <span>Split into single pages</span>
                </label>
                <input type="text" id="splitInput" placeholder="Enter page ranges" 
                       class="w-full px-4 py-2 border rounded-lg">
              </div>
            </div>
          </div>
          
          <button id="splitBtn" onclick="splitPDF()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Split PDF
          </button>
        </div>
      `;
    }
    
    // ========== COMPRESS PDF TOOL ==========
    function getCompressContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="compressOptions" class="hidden space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Compression Level</h4>
              <div class="space-y-2">
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer">
                  <input type="radio" name="compression" value="low" class="text-purple-600">
                  <div><p class="font-medium">Low</p><p class="text-sm text-gray-500">Best quality</p></div>
                </label>
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer">
                  <input type="radio" name="compression" value="medium" checked class="text-purple-600">
                  <div><p class="font-medium">Medium</p><p class="text-sm text-gray-500">Balanced</p></div>
                </label>
                <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer">
                  <input type="radio" name="compression" value="high" class="text-purple-600">
                  <div><p class="font-medium">High</p><p class="text-sm text-gray-500">Smallest file</p></div>
                </label>
              </div>
            </div>
          </div>
          
          <button id="compressBtn" onclick="compressPDF()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Compress PDF
          </button>
        </div>
      `;
    }
    
    // ========== CONVERT TO PDF TOOL ==========
    function getConvertContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop files to convert</p>
            <p class="text-sm text-gray-500 mb-4">Images (JPG, PNG) and Text (.txt)</p>
            <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.txt" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="convertFileList" class="space-y-2"></div>
          
          <div class="bg-gray-50 p-4 rounded-lg">
            <label class="flex items-center gap-2">
              <input id="mergeConverted" type="checkbox" checked class="text-purple-600">
              <span>Merge all into a single PDF</span>
            </label>
          </div>
          
          <button id="convertBtn" onclick="convertToPDF()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Convert to PDF
          </button>
        </div>
      `;
    }
    
    // ========== WATERMARK TOOL ==========
    function getWatermarkContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="watermarkOptions" class="hidden space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Watermark Settings</h4>
              <input type="text" id="watermarkText" placeholder="Enter watermark text" 
                     class="w-full px-4 py-2 border rounded-lg mb-3">
              
              <div class="grid grid-cols-2 gap-4 mb-3">
                <div>
                  <label class="block text-sm font-medium mb-1">Font Size</label>
                  <input type="range" id="wmFontSize" min="10" max="100" value="30" class="w-full">
                  <span id="fontSizeValue" class="text-xs text-gray-500">30px</span>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Opacity</label>
                  <input type="range" id="wmOpacity" min="0" max="100" value="50" class="w-full">
                  <span id="opacityValue" class="text-xs text-gray-500">50%</span>
                </div>
              </div>
              
              <label class="block text-sm font-medium mb-1">Position</label>
              <select id="watermarkPosition" class="w-full px-4 py-2 border rounded-lg mb-3">
                <option value="center">Center</option>
                <option value="top-left">Top Left</option>
                <option value="top-right">Top Right</option>
                <option value="bottom-left">Bottom Left</option>
                <option value="bottom-right">Bottom Right</option>
              </select>
              
              <label class="block text-sm font-medium mb-1">Color</label>
              <input type="color" id="watermarkColor" value="#000000" class="w-full h-10 rounded cursor-pointer">
            </div>
          </div>
          
          <button id="watermarkBtn" onclick="addWatermark()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Add Watermark
          </button>
        </div>
      `;
    }
    
    // ========== ROTATE TOOL ==========
    function getRotateContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div id="rotateOptions" class="hidden space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-semibold mb-3">Rotation Options</h4>
              <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="setRotation(90)" class="px-4 py-2 border rounded-lg hover:bg-gray-100">90°</button>
                <button onclick="setRotation(180)" class="px-4 py-2 border rounded-lg hover:bg-gray-100">180°</button>
                <button onclick="setRotation(270)" class="px-4 py-2 border rounded-lg hover:bg-gray-100">270°</button>
                <button onclick="setRotation(0)" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Reset</button>
              </div>
              
              <div class="space-y-2">
                <label class="flex items-center gap-2">
                  <input type="radio" name="rotateScope" value="all" checked class="text-purple-600">
                  <span>Rotate all pages</span>
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" name="rotateScope" value="specific" class="text-purple-600">
                  <span>Rotate specific pages</span>
                </label>
                <input type="text" id="rotatePages" placeholder="e.g., 1,3,5 or 1-5" 
                       class="w-full px-4 py-2 border rounded-lg" disabled>
              </div>
            </div>
          </div>
          
          <button id="rotateBtn" onclick="rotatePDF()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Rotate PDF
          </button>
        </div>
      `;
    }
    
    // ========== EDIT TOOL (simplified) ==========
    function getEditContent() {
      return `
        <div class="space-y-6">
          <div class="file-drop-zone p-8 rounded-lg text-center" id="dropZone">
            <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
            <p class="text-lg text-gray-600 mb-2">Drag & drop a PDF</p>
            <input type="file" id="fileInput" accept=".pdf" class="hidden" />
            <button onclick="document.getElementById('fileInput').click()" 
                    class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale">Browse Files</button>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg hidden" id="editCanvasContainer">
            <canvas id="editCanvas" class="w-full border rounded-lg" style="max-height: 500px;"></canvas>
          </div>
          
          <button id="editBtn" onclick="saveEditedPDF()" 
                  class="gradient-bg text-white px-6 py-2 rounded-lg hover-scale w-full disabled:opacity-50"
                  disabled>
            Save Edited PDF
          </button>
        </div>
      `;
    }
    
    function initEditTool() {
      initDragAndDrop();
    }
    
    // ========== DRAG & DROP ==========
    function initDragAndDrop() {
      const dropZone = $('#dropZone');
      const fileInput = $('#fileInput');
      
      if (!dropZone || !fileInput) return;
      
      ['dragover', 'dragenter'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });
      
      ['dragleave', 'dragend', 'drop'].forEach(event => {
        dropZone.addEventListener(event, (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });
      
      dropZone.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files);
        handleFileUpload(files);
      });
      
      fileInput.addEventListener('change', (e) => {
        handleFileUpload(Array.from(e.target.files));
      });
    }
    
    function handleFileUpload(files) {
      uploadedFiles = files;
      
      // Enable appropriate button and show options
      const toolBtnMap = {
        fill: '#fillBtn',
        merge: '#mergeBtn',
        split: '#splitBtn',
        compress: '#compressBtn',
        convert: '#convertBtn',
        watermark: '#watermarkBtn',
        rotate: '#rotateBtn',
        edit: '#editBtn'
      };
      
      const btnId = toolBtnMap[currentTool];
      if (btnId) {
        const btn = $(btnId);
        if (btn) {
          btn.disabled = files.length === 0;
        }
      }
      
      // Show tool-specific options
      const optionsMap = {
        split: '#splitOptions',
        compress: '#compressOptions',
        watermark: '#watermarkOptions',
        rotate: '#rotateOptions',
        edit: '#editCanvasContainer'
      };
      
      const optionsId = optionsMap[currentTool];
      if (optionsId && files.length > 0) {
        $(optionsId).classList.remove('hidden');
      }
      
      // Show form fields for fill tool
      if (currentTool === 'fill' && files.length > 0) {
        $('#formFields').classList.remove('hidden');
      }
      
      // Display file list for merge and convert
      if (currentTool === 'merge') {
        displayMergeFiles();
      } else if (currentTool === 'convert') {
        displayConvertFiles();
      }
      
      if (files.length > 0) {
        notify(`Loaded ${files.length} file(s)`, 'success');
      }
    }
    
    function displayMergeFiles() {
      const fileList = $('#fileList');
      const mergeBtn = $('#mergeBtn');
      
      fileList.innerHTML = uploadedFiles.map((file, i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-3">
            <i class="fas fa-file-pdf text-red-500"></i>
            <span class="font-medium">${file.name}</span>
            <span class="text-sm text-gray-500">(${formatFileSize(file.size)})</span>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="moveFile(${i}, -1)" class="text-gray-500 hover:text-gray-700" ${i === 0 ? 'disabled' : ''}>
              <i class="fas fa-chevron-up"></i>
            </button>
            <button onclick="moveFile(${i}, 1)" class="text-gray-500 hover:text-gray-700" ${i === uploadedFiles.length - 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-down"></i>
            </button>
            <button onclick="removeMergeFile(${i})" class="text-red-500 hover:text-red-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `).join('');
      
      mergeBtn.disabled = uploadedFiles.length < 2;
    }
    
    function displayConvertFiles() {
      const list = $('#convertFileList');
      const btn = $('#convertBtn');
      
      list.innerHTML = uploadedFiles.map((file, i) => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
          <div class="flex items-center gap-3">
            <i class="fas fa-file ${file.type.startsWith('image/') ? 'text-blue-500' : 'text-gray-500'}"></i>
            <span class="font-medium">${file.name}</span>
            <span class="text-sm text-gray-500">(${formatFileSize(file.size)})</span>
          </div>
          <button onclick="removeConvertFile(${i})" class="text-red-500 hover:text-red-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `).join('');
      
      btn.disabled = uploadedFiles.length === 0;
    }
    
    function moveFile(i, dir) {
      const j = i + dir;
      if (j >= 0 && j < uploadedFiles.length) {
        [uploadedFiles[i], uploadedFiles[j]] = [uploadedFiles[j], uploadedFiles[i]];
        displayMergeFiles();
      }
    }
    
    function removeMergeFile(i) {
      uploadedFiles.splice(i, 1);
      displayMergeFiles();
    }
    
    function removeConvertFile(i) {
      uploadedFiles.splice(i, 1);
      displayConvertFiles();
    }
    
    function clearFiles() {
      uploadedFiles = [];
      if (currentTool === 'merge') displayMergeFiles();
      else if (currentTool === 'convert') displayConvertFiles();
    }
    
    // ========== PDF OPERATIONS ==========
    async function mergePDFs() {
      if (uploadedFiles.length < 2) {
        notify('Please upload at least 2 PDF files', 'error');
        return;
      }
      
      try {
        showLoading();
        const mergedPdf = await PDFLib.PDFDocument.create();
        
        for (const file of uploadedFiles) {
          const fileBytes = await file.arrayBuffer();
          const pdf = await PDFLib.PDFDocument.load(fileBytes);
          const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          pages.forEach(page => mergedPdf.addPage(page));
        }
        
        const pdfBytes = await mergedPdf.save();
        downloadBytes(pdfBytes, 'merged.pdf');
        notify('PDFs merged successfully!', 'success');
      } catch (error) {
        console.error('Error merging PDFs:', error);
        notify('Error merging PDFs: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function splitPDF() {
      if (uploadedFiles.length === 0) {
        notify('Please upload a PDF file', 'error');
        return;
      }
      
      try {
        showLoading();
        const file = uploadedFiles[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        const totalPages = pdfDoc.getPageCount();
        
        const splitType = document.querySelector('input[name="splitType"]:checked').value;
        
        if (splitType === 'single') {
          // Split into individual pages
          for (let i = 0; i < totalPages; i++) {
            const newPdf = await PDFLib.PDFDocument.create();
            const [page] = await newPdf.copyPages(pdfDoc, [i]);
            newPdf.addPage(page);
            const pdfBytes = await newPdf.save();
            downloadBytes(pdfBytes, `page_${i + 1}.pdf`);
          }
          notify(`Split into ${totalPages} individual pages`, 'success');
        } else {
          // Split by ranges
          const ranges = $('#splitInput').value;
          if (!ranges) {
            notify('Please enter page ranges', 'error');
            return;
          }
          
          const pages = parsePageRanges(ranges, totalPages);
          const newPdf = await PDFLib.PDFDocument.create();
          const copiedPages = await newPdf.copyPages(pdfDoc, pages);
          copiedPages.forEach(page => newPdf.addPage(page));
          
          const pdfBytes = await newPdf.save();
          downloadBytes(pdfBytes, 'split.pdf');
          notify(`Extracted ${pages.length} pages`, 'success');
        }
      } catch (error) {
        console.error('Error splitting PDF:', error);
        notify('Error splitting PDF: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function parsePageRanges(input, max) {
      const result = new Set();
      const parts = input.split(',').map(p => p.trim()).filter(p => p);
      
      for (const part of parts) {
        if (part.includes('-')) {
          const [start, end] = part.split('-').map(n => parseInt(n, 10) - 1);
          const realStart = Math.max(0, Math.min(start, max - 1));
          const realEnd = Math.max(0, Math.min(end || start, max - 1));
          const rangeStart = Math.min(realStart, realEnd);
          const rangeEnd = Math.max(realStart, realEnd);
          
          for (let i = rangeStart; i <= rangeEnd; i++) {
            result.add(i);
          }
        } else {
          const page = parseInt(part, 10) - 1;
          if (page >= 0 && page < max) {
            result.add(page);
          }
        }
      }
      
      return Array.from(result).sort((a, b) => a - b);
    }
    
    async function compressPDF() {
      if (uploadedFiles.length === 0) {
        notify('Please upload a PDF file', 'error');
        return;
      }
      
      try {
        showLoading();
        const file = uploadedFiles[0];
        const arrayBuffer = await file.arrayBuffer();
        
        // For simplicity, we'll just save the original file
        // In a real implementation, you'd use PDF.js to render and compress
        downloadBytes(arrayBuffer, `compressed_${file.name}`);
        notify('PDF compressed!', 'success');
      } catch (error) {
        console.error('Error compressing PDF:', error);
        notify('Error compressing PDF: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function convertToPDF() {
      if (uploadedFiles.length === 0) {
        notify('Please upload files to convert', 'error');
        return;
      }
      
      try {
        showLoading();
        const { jsPDF } = window.jspdf;
        const merge = $('#mergeConverted')?.checked;
        
        if (merge) {
          // Merge all into one PDF
          const doc = new jsPDF();
          let first = true;
          
          for (const file of uploadedFiles) {
            if (file.type.startsWith('image/')) {
              if (!first) doc.addPage();
              first = false;
              
              const img = await fileToImage(file);
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              
              const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
              const width = img.width * ratio;
              const height = img.height * ratio;
              const x = (pageWidth - width) / 2;
              const y = (pageHeight - height) / 2;
              
              doc.addImage(img, 'JPEG', x, y, width, height);
            } else if (file.type === 'text/plain') {
              if (!first) doc.addPage();
              first = false;
              
              const text = await file.text();
              const lines = doc.splitTextToSize(text, 170);
              doc.text(lines, 20, 30);
            }
          }
          
          doc.save('converted.pdf');
        } else {
          // Create separate PDFs
          for (const file of uploadedFiles) {
            if (file.type.startsWith('image/')) {
              const doc = new jsPDF();
              const img = await fileToImage(file);
              const pageWidth = doc.internal.pageSize.getWidth();
              const pageHeight = doc.internal.pageSize.getHeight();
              
              const ratio = Math.min(pageWidth / img.width, pageHeight / img.height);
              const width = img.width * ratio;
              const height = img.height * ratio;
              const x = (pageWidth - width) / 2;
              const y = (pageHeight - height) / 2;
              
              doc.addImage(img, 'JPEG', x, y, width, height);
              doc.save(`${file.name.replace(/\.[^/.]+$/, '')}.pdf`);
            } else if (file.type === 'text/plain') {
              const doc = new jsPDF();
              const text = await file.text();
              const lines = doc.splitTextToSize(text, 170);
              doc.text(lines, 20, 30);
              doc.save(`${file.name.replace(/\.[^/.]+$/, '')}.pdf`);
            }
          }
        }
        
        notify('Files converted to PDF!', 'success');
      } catch (error) {
        console.error('Error converting to PDF:', error);
        notify('Error converting files: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function fileToImage(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = URL.createObjectURL(file);
      });
    }
    
    async function addWatermark() {
      if (uploadedFiles.length === 0) {
        notify('Please upload a PDF file', 'error');
        return;
      }
      
      try {
        showLoading();
        const file = uploadedFiles[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        
        const text = $('#watermarkText').value || 'WATERMARK';
        const fontSize = parseInt($('#wmFontSize').value);
        const opacity = parseInt($('#wmOpacity').value) / 100;
        const position = $('#watermarkPosition').value;
        const color = hexToRgb($('#watermarkColor').value);
        
        const pages = pdfDoc.getPages();
        
        pages.forEach((page) => {
          const { width, height } = page.getSize();
          let x, y;
          
          switch (position) {
            case 'top-left':
              x = 50;
              y = height - 50;
              break;
            case 'top-right':
              x = width - 150;
              y = height - 50;
              break;
            case 'bottom-left':
              x = 50;
              y = 50;
              break;
            case 'bottom-right':
              x = width - 150;
              y = 50;
              break;
            default: // center
              x = width / 2 - (fontSize * text.length * 0.25);
              y = height / 2;
          }
          
          page.drawText(text, {
            x,
            y,
            size: fontSize,
            color: PDFLib.rgb(color.r / 255, color.g / 255, color.b / 255),
            opacity: opacity,
          });
        });
        
        const pdfBytes = await pdfDoc.save();
        downloadBytes(pdfBytes, `watermarked_${file.name}`);
        notify('Watermark added!', 'success');
      } catch (error) {
        console.error('Error adding watermark:', error);
        notify('Error adding watermark: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 0, g: 0, b: 0 };
    }
    
    let rotationAngle = 0;
    
    function setRotation(angle) {
      rotationAngle = angle;
      notify(`Rotation set to ${angle}°`, 'info');
    }
    
    async function rotatePDF() {
      if (uploadedFiles.length === 0) {
        notify('Please upload a PDF file', 'error');
        return;
      }
      
      try {
        showLoading();
        const file = uploadedFiles[0];
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
        
        const scope = document.querySelector('input[name="rotateScope"]:checked').value;
        const pages = pdfDoc.getPages();
        
        if (scope === 'all') {
          pages.forEach(page => {
            page.setRotation(PDFLib.degrees(rotationAngle));
          });
        } else {
          const pagesInput = $('#rotatePages').value;
          const pageNumbers = parsePageRanges(pagesInput, pages.length);
          
          pageNumbers.forEach(pageIndex => {
            if (pageIndex >= 0 && pageIndex < pages.length) {
              pages[pageIndex].setRotation(PDFLib.degrees(rotationAngle));
            }
          });
        }
        
        const pdfBytes = await pdfDoc.save();
        downloadBytes(pdfBytes, `rotated_${file.name}`);
        notify('PDF rotated!', 'success');
      } catch (error) {
        console.error('Error rotating PDF:', error);
        notify('Error rotating PDF: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }
    
    async function saveEditedPDF() {
      // Simple implementation - creates a blank PDF with a message
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.text('PDF editing functionality coming soon!', 20, 30);
      doc.text('For now, use Fill & Sign or Watermark tools.', 20, 50);
      
      doc.save('edited.pdf');
      notify('Sample edited PDF saved!', 'success');
    }
    
    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Set current year
      $('#year').textContent = new Date().getFullYear();
      
      // Initialize event listeners for sliders
      document.addEventListener('input', (e) => {
        if (e.target.id === 'wmFontSize') {
          $('#fontSizeValue').textContent = e.target.value + 'px';
        }
        if (e.target.id === 'wmOpacity') {
          $('#opacityValue').textContent = e.target.value + '%';
        }
      });
      
      // Rotate scope change
      document.addEventListener('change', (e) => {
        if (e.target.name === 'rotateScope') {
          $('#rotatePages').disabled = e.target.value !== 'specific';
        }
      });
      
      // Create tool radio change
      document.addEventListener('change', (e) => {
        if (e.target.name === 'createType') {
          const type = e.target.value;
          $('#textCreate').classList.toggle('hidden', type !== 'text');
          $('#imageCreate').classList.toggle('hidden', type !== 'images');
          $('#blankCreate').classList.toggle('hidden', type !== 'blank');
        }
      });
    });
  </script>
</body>
</html>
